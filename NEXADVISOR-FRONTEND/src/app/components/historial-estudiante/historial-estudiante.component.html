<div>
  <h2>Historial de Reservas</h2>

  <table *ngIf="reservas.length > 0" border="1" style="width: 100%; margin-bottom: 20px;">
    <thead>
      <tr>
        <th>Asesor</th>
        <th>Fecha</th>
        <th>Hora</th>
        <th>Estado</th>
        <th>Comentario del Asesor</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      <ng-container *ngFor="let reserva of reservas">
        <tr>
          <td>{{ reserva.asesor.nombre }}</td>
          <td>{{ reserva.fechaReserva | date: 'shortDate' }}</td>
          <td>{{ reserva.horaReserva }}</td>
          <td>{{ reserva.estado }}</td>
          <td>{{ reserva.comentarioAsesor || 'Sin comentario' }}</td>
          <td>
            <button *ngIf="reservaIdPuntuacion === 0" (click)="seleccionarReserva(reserva.id)">Puntuar</button>
            <input type="file" id="inputCV-{{ reserva.id }}" hidden (change)="enviarCV($event, reserva.id)" />
            <button (click)="abrirSelectorArchivo(reserva.id)">Subir CV</button>

            <!-- NUEVO: Mensaje de resultado del CV -->
            <p *ngIf="resultadoSubida[reserva.id]" style="margin-top: 5px; font-size: 0.9em; color: green;">
              {{ resultadoSubida[reserva.id] }}
            </p>

            <button (click)="abrirFormularioComentario(reserva)">Comentar</button>
          </td>
        </tr>

        <!-- Formulario para comentar: SOLO si coincide el ID -->
        <tr *ngIf="comentarioReservaActiva?.id === reserva.id">
          <td colspan="6">
            <h4>Dejar comentario para {{ reserva.asesor.nombre }}</h4>
            <textarea
              [(ngModel)]="comentarioNuevo.contenido"
              placeholder="Escribe tu comentario aquí"
              rows="4"
              cols="50"
            ></textarea><br /><br />
            <button (click)="guardarComentario()">Enviar comentario</button>
            <button (click)="cancelarFormularioComentario()" style="margin-left: 10px;">Cancelar</button>
          </td>
        </tr>
      </ng-container>
    </tbody>
  </table>

  <!-- Formulario para puntuar asesor -->
  <div *ngIf="reservaIdPuntuacion !== 0" style="margin-top: 20px;">
    <h3>Puntuar asesor</h3>

    <label for="puntaje">Puntaje (1-5):</label><br />
    <input
      id="puntaje"
      type="number"
      [(ngModel)]="puntuacion.puntuacion"
      min="1"
      max="5"
      required
    /><br /><br />

    <button (click)="registrarPuntuacion()">Enviar</button>
    <button (click)="cancelarPuntuacion()" style="margin-left: 10px;">Cancelar</button>

    <p style="color: green;" *ngIf="mensaje">{{ mensaje }}</p>
  </div>

  <p *ngIf="reservas.length === 0">No tienes reservas registradas aún.</p>
</div>
